name: taosgen Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # - runner: ubuntu-22.04
          #   arch: x64
          #   conan_arch: x86_64

          # - runner: [self-hosted, Linux, X64, taosgen]
          #   arch: x64
          #   conan_arch: x86_64
          - runner: [self-hosted, Linux, ARM64, taosgen]
            arch: arm64
            conan_arch: armv8

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Show environment info
        run: |
          echo "OS: $(uname -a)"
          echo "User: $(whoami)"
          echo "HOME: $HOME"
          echo "PWD: $(pwd)"
          if [ "${{ runner.os }}" = "Linux" ]; then
            id
            ls -ld $HOME
          elif [ "${{ runner.os }}" = "macOS" ]; then
            id
            ls -ld $HOME
          elif [ "${{ runner.os }}" = "Windows" ]; then
            whoami
            echo "USERPROFILE: $USERPROFILE"
            echo "HOMEPATH: $HOMEPATH"
            echo "HOMEDRIVE: $HOMEDRIVE"
          fi

      - name: Ensure Python3 and pip
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y python3 python3-pip python3-venv
            if ! command -v python >/dev/null; then
              sudo ln -sf /usr/bin/python3 /usr/bin/python
            fi
            if ! command -v pip >/dev/null && command -v pip3 >/dev/null; then
              sudo ln -sf $(command -v pip3) /usr/bin/pip
            fi
          elif [ "${{ runner.os }}" = "macOS" ]; then
            if ! command -v python3 >/dev/null; then
              brew install python
            fi
            if ! command -v python >/dev/null; then
              ln -sf /usr/local/bin/python3 /usr/local/bin/python || true
            fi
          fi
          python --version || true
          python3 --version || true
          pip --version || true
          pip3 --version || true

      - name: Get latest TDengine version
        id: get_td_version
        run: |
          if [ "${{ runner.os }}" = "macOS" ]; then
            brew install jq
          fi
          version=$(curl -s https://api.github.com/repos/taosdata/TDengine/releases/latest | jq -r .name)
          version=${version#v}
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Cache TDengine
        id: cache-tdengine
        uses: actions/cache@v4
        with:
          path: ~/.tdengine-cache
          key: tdengine-${{ steps.get_td_version.outputs.version }}-${{ runner.os }}-${{ matrix.arch }}

      - name: Download TDengine
        if: steps.cache-tdengine.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.tdengine-cache
          cd ~/.tdengine-cache
          if [ "${{ runner.os }}" = "Linux" ]; then
            arch="${{ matrix.arch }}"
            version="${{ steps.get_td_version.outputs.version }}"
            pkg="tdengine-tsdb-enterprise-${version}-linux-${arch}.tar.gz"

            # Clean up old packages
            pwd
            ls -al
            for f in tdengine-tsdb-enterprise-*-linux-*.tar.gz; do
              [ -e "$f" ] || continue
              if [ "$f" != "$pkg" ]; then
                echo "Deleting old package: $f"
                rm -f "$f"
              fi
            done

            # Download if not exists
            url="https://downloads.taosdata.com/tdengine-tsdb-enterprise/${version}/${pkg}"
            if [ -f "$pkg" ] && [ $(stat -c%s "$pkg") -gt $((300*1024*1024)) ]; then
              echo "$pkg already exists and is larger than 300MB, skip download."
            else
              echo "Download URL: $url"
              curl -fSL "$url" -o "$pkg"
            fi
            pwd
            ls -al

          elif [ "${{ runner.os }}" = "macOS" ]; then
            echo "TODO: macOS download logic"
          fi

      - name: Install & Start TDengine
        run: |
          cd ~/.tdengine-cache
          arch="${{ matrix.arch }}"
          version="${{ steps.get_td_version.outputs.version }}"

          if [ "${{ runner.os }}" = "Linux" ]; then
            pkg="tdengine-tsdb-enterprise-${version}-linux-${arch}.tar.gz"
            # Extract
            tar -xzf "$pkg"
            pwd
            ls -al
            dir="tdengine-tsdb-enterprise-${version}"
            cd "$dir"
            # Install
            sudo ./install.sh -e no
            # Start TDengine
            sudo systemctl start taosd
            sudo systemctl start taosadapter
            # Check status
            sudo systemctl status taosd
            sudo systemctl status taosadapter
            # Verify installation
            taos -V

          elif [ "${{ runner.os }}" = "macOS" ]; then
            echo "TODO: macOS extract logic"
          fi

      - name: Checkout taosgen code
        uses: actions/checkout@v4

      - name: Install CMake (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          version=3.20.0
          if ! cmake --version | grep -q "$version"; then
            sudo apt-get remove --purge --auto-remove cmake -y || true
            arch=$(uname -m)
            if [ "$arch" = "x86_64" ]; then
              arch_str="x86_64"
            elif [ "$arch" = "aarch64" ]; then
              arch_str="aarch64"
            else
              echo "Unsupported arch: $arch"
              exit 1
            fi
            wget -qO- "https://github.com/Kitware/CMake/releases/download/v${version}/cmake-${version}-linux-${arch_str}.tar.gz" | sudo tar --strip-components=1 -xz -C /usr/local
          fi
          file $(which cmake)
          cmake --version

      - name: Install CMake (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake
          file $(which cmake)
          cmake --version

      - name: Install CMake (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake --version=3.20.0 -y
          cmake --version

      - name: Setup Conan
        uses: conan-io/setup-conan@v1
        with:
          version: 2.20.1
          use_venv: true

      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: $HOME/.conan2/p
          key: conan2-${{ runner.os }}-${{ matrix.conan_arch }}-${{ hashFiles('conanfile.*') }}
          restore-keys: conan2-${{ runner.os }}-${{ matrix.conan_arch }}-

      - name: Create build directory
        run: mkdir build

      - name: Install dependencies
        working-directory: build
        run: |
          conan install .. \
            --build=missing \
            --output-folder=./conan \
            --settings=build_type=Debug \
            --settings=arch=${{ matrix.conan_arch }} \
            --settings=compiler.cppstd=17

      - name: Configure CMake
        working-directory: build
        run: |
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_INSTALL_PREFIX=./install \
            -DCMAKE_PREFIX_PATH=./conan

      - name: Build
        working-directory: build
        run: cmake --build . --config Debug -j $(nproc || sysctl -n hw.ncpu)

      - name: Test
        if: runner.os == 'Linux'
        working-directory: build
        run: ctest --output-on-failure